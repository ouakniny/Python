FactPlan	measure	ScoreTotal:=CALCULATE(AVERAGE('FactPlan'[SCORE]),ALL('FactPlan'[PERSA]))
FactPlan	measure	ScoreMisrad:=AVERAGE('FactPlan'[SCORE])
FactPlan	measure	ScoreSystem_1:=CALCULATE(AVERAGE('FactPlan'[SCORE]),'FactPlan'[SYSTEM]=1,ALL('FactPlan'[PERSA]))
FactPlan	measure	ScoreSystem_2:=CALCULATE(AVERAGE('FactPlan'[SCORE]),'FactPlan'[SYSTEM]=2,ALL('FactPlan'[PERSA]))
FactPlan	measure	ScoreMisradY1:=CALCULATE([ScoreMisrad],PARALLELPERIOD('CalendarYear'[Date],-1,YEAR))
FactPlan	measure	ScoreSystem_1Y1:=CALCULATE([ScoreSystem_1],PARALLELPERIOD('CalendarYear'[Date],-1,YEAR))
FactPlan	measure	ScoreSystem_2Y1:=CALCULATE([ScoreSystem_2],PARALLELPERIOD('CalendarYear'[Date],-1,YEAR))
FactPlan	measure	ScoreTotalY1:=CALCULATE([ScoreTotal],PARALLELPERIOD('CalendarYear'[Date],-1,YEAR))
FactPlan	measure	ScoreMisradDelta:=[ScoreMisrad]-[ScoreMisradY1]
FactPlan	measure	ScoreTotalDelta:=[ScoreTotal]-[ScoreTotalY1]
FactPlan	measure	ScoreSystem:=IF(FIRSTNONBLANK('FactPlan'[SYSTEM],1)=1,[ScoreSystem_1],[ScoreSystem_2])
FactPlan	measure	ScoreSystemY1:=IF(FIRSTNONBLANK('FactPlan'[SYSTEM],1)=1,[ScoreSystem_1Y1],[ScoreSystem_2Y1])
FactPlan	measure	ScoreSystemDelta:=[ScoreSystem]-[ScoreSystemY1]
FactPlan	measure	RateMisrad:=DIVIDE([CumulEvaluations],[CumulPotential],BLANK())
FactPlan	measure	RateTotal:=CALCULATE([RateMisrad],ALL('FactPlan'[PERSA]))
FactPlan	measure	CumulEvaluations:=CALCULATE(SUM('FactPlan'[EVALUATION]),DATESBETWEEN('CalendarEvaluation'[Date],STARTOFYEAR('CalendarEvaluation'[Date]),MAX('CalendarEvaluation'[Date])))
FactPlan	measure	CumulPotential:=CALCULATE(SUM('FactPlan'[POTENTIAL]),ALLSELECTED('CalendarEvaluation'))
FactPlan	measure	EvaluationsTotal:=CALCULATE(sum('FactPlan'[EVALUATION]),ALLSELECTED('FactPlan'))
FactPlan	measure	RateSimulation:=IF(FIRSTNONBLANK('CalendarEvaluation'[Date],1)<=DATE(YEAR(FIRSTNONBLANK('CalendarEvaluation'[Date],1)),5,31),DIVIDE(1,108)*FIRSTNONBLANK('CalendarEvaluation'[WorkingDayNoOfYear],1),1)
FactPlan	measure	Rest:=SUM('FactPlan'[POTENTIAL])-SUM('FactPlan'[EVALUATION])
FactPlan	measure	Rate:=DIVIDE(SUM('FactPlan'[EVALUATION]),SUM('FactPlan'[POTENTIAL]))
FactPlan	measure	DailyRateMisrad:=DIVIDE([Rate],MAX(FactPlan[LastDate]))*[CumulPotential]
FactPlan	measure	DailyRateSimulation:=[RateSimulation]*[CumulPotential]
FactPlan	measure	AlertRate:=IF([DailyRateMisrad]<[DailyRateSimulation],"קצב מילוי הנוכחי הוא "&FIXED([DailyRateMisrad],1)&" עובדים פר יום כדי להגיע ל100% לפני סוף מאי צריך קצב של "&FIXED([DailyRateSimulation],1)&" עובדים פר יום",BLANK())
FactPlan	measure	AlertRateTransparent:=IF([DailyRateMisrad]<[DailyRateSimulation],"Red","#FFFFFF00")
FactPlan	column	Y1Label:=":שנה קודמת"
FactPlan	column	LastDate:=RELATED(CalendarEvaluation[WorkingDayNoOfYear])
FactOrganization	measure	CompletionRate_Internal:=DIVIDE(SUM(FactOrganization[Evaluation]),SUM(FactOrganization[Potential]))
FactOrganization	measure	OrganizationRate:=IF(ISFILTERED('FactPlan'[BTRTL])     ,CALCULATE([CompletionRate_Internal],FactOrganization[Attribute]="ORGUNITTXT")     ,IF(ISFILTERED('FactPlan'[PERSA])         ,CALCULATE([CompletionRate_Internal],FactOrganization[Attribute]="SECTOR")         ,IF(AND(NOT(ISFILTERED('FactPlan'[BTRTL])),NOT(ISFILTERED('FactPlan'[PERSA])))             ,CALCULATE([CompletionRate_Internal],FactOrganization[Attribute]="PERSATXT")             ,BLANK()         )     ) )
FactOrganization	measure	TitleOrganization:=IF(ISFILTERED('FactPlan'[BTRTL])     ,"אחוז מילוי עבור סקטור "&SELECTEDVALUE('FactPlan'[BTRTL])     ,IF(ISFILTERED('FactPlan'[PERSA])         ,"אחוז מילוי עבור  "&SELECTEDVALUE('FactPlan'[PERSA])         ,IF(AND(NOT(ISFILTERED('FactPlan'[BTRTL])),NOT(ISFILTERED('FactPlan'[PERSA])))             ,"אחוז מילוי עבור אזור עובדים"             ,BLANK()         )     ) )
FactCompare	measure	CompareScore:=IF(ISFILTERED(FactPlan[PERSA]),FactCompare[CompareScoreMisradSelected],FactCompare[CompareScoreMisradNotSelected])
FactCompare	measure	CompareScoreMisradSelected:=SWITCH(FIRSTNONBLANK(FactCompare[Attribute],1) ,"PERSATXT",[ScoreMisrad] ,"TOTAL",[ScoreTotal] ,"SYSTEM",[ScoreSystem] )
FactCompare	measure	CompareScoreMisradNotSelected:=SWITCH(FIRSTNONBLANK(FactCompare[Attribute],1) ,"TOTAL",[ScoreTotal] ,"SYSTEM",IF(FIRSTNONBLANK(FactCompare[VALUE_ID],1)=1,[ScoreSystem_1],[ScoreSystem_2]) ,BLANK() )
FactCompare	column	BarColor:=SWITCH(FactCompare[Attribute],"PERSATXT","#3498DB","SYSTEM","#8DB4D8","TOTAL","#204060")
FactSimulation	measure	SimulationRate:=IF(ISFILTERED(FactPlan[PERSA]),FactSimulation[SimulationRateMisradSelected],FactSimulation[SimulationRateMisradNotSelected])
FactSimulation	measure	SimulationRateMisradSelected:=SWITCH(FIRSTNONBLANK(FactSimulation[Attribute],1)     ,"PERSATXT",[RateMisrad]     ,"TOTAL",[RateTotal]     ,"SIMULATION",[RateSimulation] )
FactSimulation	measure	SimulationRateMisradNotSelected:=SWITCH(FIRSTNONBLANK(FactSimulation[Attribute],1)     ,"TOTAL",[RateTotal]     ,"SIMULATION",[RateSimulation]     ,BLANK() )
CalendarYear	column	Year:=YEAR(CalendarYear[Date])
CalendarEvaluation	measure	LastUpdate:="תאריך עידכון: "&LASTDATE(CalendarEvaluation[Date])
CalendarEvaluation	column	Month:=FORMAT(CalendarEvaluation[Date],"YYYYMM")
CalendarEvaluation	column	Week:=year(CalendarEvaluation[Date])&"W"&FORMAT(WEEKNUM(CalendarEvaluation[Date]),"00")
CalendarEvaluation	column	Day:=fORMAT(CalendarEvaluation[Date],"YYYYMMDD")
CalendarEvaluation	column	IsWorkingDay:=NOT WEEKDAY( 'CalendarEvaluation'[Date] ) IN { 6,7 }
CalendarEvaluation	column	Today:=Today()
CalendarEvaluation	column	WorkingDayNoOfYear:=DATEDIFF ( STARTOFYEAR('CalendarEvaluation'[Date]), 'CalendarEvaluation'[Date], DAY ) + 1 - CALCULATE(COUNTROWS('CalendarEvaluation') ,DATESBETWEEN ( 'CalendarEvaluation'[Date],  STARTOFYEAR('CalendarEvaluation'[Date]), 'CalendarEvaluation'[Date]) ,'CalendarEvaluation'[IsWorkingDay]=FALSE())
CalendarEvaluation	column	Year:=YEAR(CalendarEvaluation[Date])
